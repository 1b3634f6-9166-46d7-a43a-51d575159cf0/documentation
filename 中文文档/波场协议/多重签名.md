多重签名
===

[1.背景需求](#1) \
[2.权限级别](#2) \
[2.1 关键结构说明](#2.1) \
[2.2 Owner权限](#2.2)\
[2.3 Witness权限](#2.3)\
[2.4 Active权限](#2.4)\
[3.API](#3) \
[3.1 Owner权限](#3.1)\
[3.2 Witness权限](#3.2)\
[4.交易流程](#4) \
[5.其他问题](#5) 

## <h2 id="1">1.背景需求</h2>   

目前TRON的所有交易签名，都是用的同一个私钥完成。没有权限分级，也不能实现多人共同控制账户。因此，设计并实现多重签名功能，每个权限可以对应多个私钥。

 https://github.com/tronprotocol/TIPs/issues/16

## <h2 id="2">2.权限级别</h2>   

包含三种权限级别，owner、witness以及active权限，其中owner权限具有执行所有合约的权限，witness权限用于超级代表出块，active是自定义权限，可以组合权限集合，以下将详细说明。

### <h2 id="2.1">2.1 关键结构说明</h2>
  
新增基本结构

     message Account { 
       *** 
       //在账户中新增三个权限属性
       Permission owner_permission = 31;
       Permission witness_permission = 32;
       repeated Permission active_permission = 33;
     }
     
     message Permission {
       enum PermissionType {
         Owner = 0;
         Witness = 1;
         Active = 2;
       }
       PermissionType type = 1;
       //Owner id=0, Witness id=1, Active id start by 2，由系统自动递增分配
       //合约执行时指定权限id，未指定时默认为0（owner），合约id不允许为1（witness） 
       int32 id = 2;     //
       string permission_name = 3;
       int64 threshold = 4;//阈值
       int32 parent_id = 5;
        //共32字节（256位），每位代表一个合约的权限，为1时表示拥有该合约的权限
        //如100...0,表示该permission只拥有AccountCreateContract的权限
       bytes operations = 6;  
       repeated Key keys = 7;// 共同拥有该权限的地址列表
     }
     
     //每个permmission有一个域值，每个地址都有一个权重，只有当参与签名的权重之和超过域值才允许做相应的操作。
     message Key {
       bytes address = 1;
       int64 weight = 2;
     }
     
     message Transaction {
       message Contract {
         enum ContractType {
           AccountCreateContract = 0; 
           ... 
           AccountPermissionUpdateContract = 46;
           PermissionAddKeyContract = 47;
           PermissionUpdateKeyContract = 48;
           PermissionDeleteKeyContract = 49;
           }
         }  
       }
     }
      
 
 
 
### <h2 id="2.2">2.2 Owner权限</h2>
OwnerPermission为账户的最高权限，用于控制用户的所有权、调整权限结构，Owner权限也可以调整自身结构，执行所有合约。
使用场景比如：

注意：
1、拥有OwnerPermission的地址可以修改OwnerPermission。\
1、当OwnerPermission为空时，默认采用该账户的地址。\
2、账户新建时，自动将该账户的地址填充到OwnerPermission中，默认状态的域值为1，keys中仅包含该账户地址且权重为1。\
3、当执行合约时未指定permissionId时， 默认采用OwnerPermission。



### <h2 id="2.3">2.3 Witness权限</h2>
超级代表可使用该权限，管理出块节点。非witness账户无该权限。

使用场景示例：一个超级代表在云服务器上部署出块程序，为了账户安全，此时可以将出块权限赋予另一个地址。由于该地址仅具有出块权限，无TRX转出权限，即使该服务器上私钥被泄密，也不会出现TRX丢失。

不使用witness权限的出块节点，无需特殊配置。\
使用witness权限的节点，除了需要执行修改witness权限的合约以外，还需要在对出块节点进行重新配置。

```

#config.conf

// Optional.The default is empty.
// It is used when the witness account has set the witnessPermission.
// When it is not empty, the localWitnessAccountAddress represents the address of the witness account,
// and the localwitness is configured with the private key of the witnessPermissionAddress in the witness account.
// When it is empty,the localwitness is configured with the private key of the witness account.

//localWitnessAccountAddress =

localwitness = [
  f4df789d3210ac881cb900464dd30409453044d2777060a0c391cbdf4c6a4f57
]

```


### <h2 id="2.4">2.4 Active权限</h2>
Active权限，用于提供一个权限的组合，比如提供一个只能执行创建账户、转账功能的权限。 

注意：
1、拥有OwnerPermission的地址可以修改Active权限
2、拥有执行AccountPermissionUpdateContract权限的地址也能够修改Active权限
1、最多支持8个组合。
1、permission的id从2开始自动递增。
 
 
## <h2 id="3">3.API</h2>  

### <h2 id="3.1">3.1 修改权限</h2>
AccountPermissionUpdateContract

### <h2 id="3.2">3.2 执行合约</h2>


## <h2 id="4">4.交易流程</h2>  

创建交易\
用户A签名，将签名后交易通过其他方式发送给B。\
用户B签名，将签名后交易通过其他方式发送给C。\
…\
最后一个完成签名的用户，将交易广播到节点。\
验证多重签名的权重之和大于域值则接受交易，否则拒绝交易


## <h2 id="5">5.其他问题</h2>  
1、兼容性说明  
 